# v0.5.1 Enhancement Plan

**Status:** In Progress
**Date:** 2025-12-01
**Branch:** feature/v0.5.1-enhancements

---

## Overview

This release adds three feature sets:
1. **Canvas Navigation Enhancements** - Navigation nodes and master overview canvases
2. **GEDCOM X Format Support** - Modern JSON-based genealogical data format
3. **Gramps XML Import** - Import from popular open-source genealogy software

---

## Feature 1: Canvas Navigation Enhancements

Builds on the Split Canvas Wizard from v0.5.0 by adding inter-canvas linking.

### 1.1 Navigation Nodes

Special nodes that link split canvases together.

**Implementation:**

```typescript
// Navigation node types
interface NavigationNode {
    type: 'portal' | 'file-link' | 'placeholder';
    targetCanvas: string;      // Path to linked canvas
    label: string;             // Display text
    direction: 'ancestor' | 'descendant' | 'sibling' | 'overview';
    personCount?: number;      // People in linked canvas
    generationRange?: [number, number];
}
```

**Visual Design:**
- Portal nodes: Text nodes with arrow icons and person counts
- File-link nodes: Obsidian file nodes pointing to .canvas files (clickable)
- Placeholder nodes: Simplified person cards with "See: [Canvas Name]" link

**Placement Strategy:**
1. At generation boundaries (top/bottom of split canvases)
2. At the root person's position (links to related canvases)
3. At branch split points (paternal/maternal)

**Files to modify/create:**
- `src/core/navigation-node-generator.ts` (new)
- `src/core/canvas-split.ts` (add navigation node generation)
- `src/core/canvas-generator.ts` (add navigation node support)
- `styles/canvas-navigation.css` (navigation node styling)

### 1.2 Master Overview Canvas

High-level canvas showing the structure of split canvas sets.

**Overview Types:**

1. **Generation Overview** - Nodes for each generation range
2. **Branch Overview** - Family branch hierarchy
3. **Collection Overview** - Already partially implemented

**Canvas Structure:**
```
┌─────────────────────────────────────────────────────────┐
│                   {Root Name} Overview                   │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐ │
│  │ Ancestors   │ ── │ Core Family │ ── │ Descendants │ │
│  │ 45 people   │    │ 12 people   │    │ 28 people   │ │
│  │ Gen -4..-2  │    │ Gen -1..+1  │    │ Gen +2..+4  │ │
│  └─────────────┘    └─────────────┘    └─────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**Features:**
- Each node is a clickable file link to the detailed canvas
- Shows person count and generation range
- Edge connections show relationships between canvases
- Stored metadata links overview to component canvases

**Files to modify/create:**
- `src/core/overview-canvas-generator.ts` (new)
- `src/ui/split-wizard-modal.ts` (add overview generation option)

### 1.3 Integration with Split Wizard

Update the Split Wizard to optionally generate:
- Navigation nodes on each split canvas
- Master overview canvas linking all splits

**New wizard options:**
```
┌─ Navigation Options ─────────────────────────────────────┐
│ ☑ Generate navigation nodes                              │
│ ☑ Generate overview canvas                               │
│   Overview filename: [john-smith-overview    ]           │
└──────────────────────────────────────────────────────────┘
```

---

## Feature 2: GEDCOM X Format Support

[FamilySearch GEDCOM X](https://github.com/FamilySearch/gedcomx) is a modern JSON/XML format for genealogical data.

### 2.1 Format Overview

GEDCOM X uses JSON structure (not the line-based GEDCOM 5.5.1):

```json
{
  "persons": [
    {
      "id": "P001",
      "names": [{ "nameForms": [{ "fullText": "John Smith" }] }],
      "gender": { "type": "http://gedcomx.org/Male" },
      "facts": [
        { "type": "http://gedcomx.org/Birth", "date": { "original": "1850" } }
      ]
    }
  ],
  "relationships": [
    { "type": "http://gedcomx.org/ParentChild", "person1": {"resource": "#P001"}, "person2": {"resource": "#P002"} }
  ]
}
```

### 2.2 Implementation

**Parser Structure:**
```typescript
interface GedcomXPerson {
    id: string;
    names: GedcomXName[];
    gender?: GedcomXGender;
    facts: GedcomXFact[];
    links?: GedcomXLink[];
}

interface GedcomXRelationship {
    id: string;
    type: string;  // ParentChild, Couple
    person1: { resource: string };
    person2: { resource: string };
    facts?: GedcomXFact[];  // Marriage date/place for Couple
}

interface GedcomXData {
    persons: GedcomXPerson[];
    relationships: GedcomXRelationship[];
    sourceDescriptions?: GedcomXSourceDescription[];
}
```

**Files to create:**
- `src/gedcomx/gedcomx-parser.ts` - Parse GEDCOM X JSON
- `src/gedcomx/gedcomx-importer.ts` - Convert to Canvas Roots format
- `src/gedcomx/gedcomx-types.ts` - TypeScript interfaces

**Integration:**
- Add to Import/Export tab in Control Center
- Reuse existing import results modal
- Support both .json and .gedx file extensions

### 2.3 Field Mapping

| GEDCOM X | Canvas Roots |
|----------|--------------|
| persons[].id | cr_id (generate new, store original as gedcomx_id) |
| names[0].nameForms[0].fullText | name |
| gender.type | gender (M/F extracted from URI) |
| facts[type=Birth].date | born |
| facts[type=Birth].place | birth_place |
| facts[type=Death].date | died |
| facts[type=Death].place | death_place |
| facts[type=Occupation].value | occupation |
| relationships[type=ParentChild] | father/mother + father_id/mother_id |
| relationships[type=Couple] | spouse + spouse_id |

---

## Feature 3: Gramps XML Import

[Gramps](https://gramps-project.org/) is a popular open-source genealogy program that exports to XML.

### 3.1 Format Overview

Gramps XML structure:
```xml
<database>
  <people>
    <person handle="_a1b2c3" id="I0001">
      <gender>M</gender>
      <name type="Birth Name">
        <first>John</first>
        <surname>Smith</surname>
      </name>
      <eventref hlink="_e1" role="Primary"/>
    </person>
  </people>
  <families>
    <family handle="_f1" id="F0001">
      <father hlink="_a1b2c3"/>
      <mother hlink="_a2b3c4"/>
      <childref hlink="_a3b4c5"/>
    </family>
  </families>
  <events>
    <event handle="_e1" id="E0001">
      <type>Birth</type>
      <dateval val="1850-03-15"/>
      <place hlink="_p1"/>
    </event>
  </events>
  <places>
    <placeobj handle="_p1" id="P0001">
      <pname value="London, England"/>
    </placeobj>
  </places>
</database>
```

### 3.2 Implementation

**Parser Structure:**
```typescript
interface GrampsPerson {
    handle: string;      // Internal reference
    id: string;          // Display ID (I0001)
    gender: 'M' | 'F' | 'U';
    names: GrampsName[];
    eventRefs: string[]; // Links to events
}

interface GrampsFamily {
    handle: string;
    id: string;
    fatherRef?: string;
    motherRef?: string;
    childRefs: string[];
    eventRefs?: string[];  // Marriage events
}

interface GrampsEvent {
    handle: string;
    id: string;
    type: string;        // Birth, Death, Marriage, etc.
    date?: string;
    placeRef?: string;
}

interface GrampsData {
    people: Map<string, GrampsPerson>;
    families: Map<string, GrampsFamily>;
    events: Map<string, GrampsEvent>;
    places: Map<string, GrampsPlace>;
}
```

**Files to create:**
- `src/gramps/gramps-parser.ts` - Parse Gramps XML
- `src/gramps/gramps-importer.ts` - Convert to Canvas Roots format
- `src/gramps/gramps-types.ts` - TypeScript interfaces

**XML Parsing:**
- Use DOMParser (browser-native, no dependencies)
- Handle Gramps-specific quirks (handle vs id references)
- Resolve event and place references during import

### 3.3 Field Mapping

| Gramps XML | Canvas Roots |
|------------|--------------|
| person/@handle | gramps_handle (preserve for reference) |
| person/@id | gramps_id (I0001 format) |
| person/name/first + surname | name |
| person/gender | gender |
| event[type=Birth]/dateval | born |
| event[type=Birth]/place | birth_place |
| event[type=Death]/dateval | died |
| event[type=Death]/place | death_place |
| family/father + mother | father/mother relationships |
| family/childref | children relationships |

---

## Implementation Phases

### Phase 1: Navigation Nodes (Priority: High)

1. Create NavigationNodeGenerator service
2. Add navigation node types to canvas data structures
3. Update canvas-split.ts to optionally include navigation nodes
4. Add styling for navigation nodes
5. Test with split wizard

### Phase 2: Master Overview Canvas (Priority: High)

1. Create OverviewCanvasGenerator service
2. Implement generation overview layout
3. Implement branch overview layout
4. Add overview generation to split wizard
5. Store overview-to-component relationships in metadata

### Phase 3: GEDCOM X Import (Priority: Medium)

1. Create gedcomx-types.ts with TypeScript interfaces
2. Create gedcomx-parser.ts for JSON parsing
3. Create gedcomx-importer.ts for conversion to Canvas Roots
4. Add GEDCOM X section to Import/Export tab
5. Add validation and import results

### Phase 4: Gramps XML Import (Priority: Medium)

1. Create gramps-types.ts with TypeScript interfaces
2. Create gramps-parser.ts for XML parsing
3. Create gramps-importer.ts for conversion to Canvas Roots
4. Add Gramps section to Import/Export tab
5. Handle event/place resolution

---

## UI Integration

### Import/Export Tab Updates

```
┌─ Import ─────────────────────────────────────────────────┐
│                                                          │
│ GEDCOM 5.5.1 (.ged)                                      │
│ [Choose file...] [Import]                                │
│                                                          │
│ GEDCOM X (.json, .gedx)                          [NEW]   │
│ [Choose file...] [Import]                                │
│                                                          │
│ Gramps XML (.gramps, .xml)                       [NEW]   │
│ [Choose file...] [Import]                                │
│                                                          │
│ CSV/TSV (.csv, .tsv)                                     │
│ [Choose file...] [Import]                                │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

### Split Wizard Updates

Add new step or options for navigation:
- Checkbox: "Generate navigation nodes"
- Checkbox: "Generate overview canvas"
- Input: Overview canvas filename

---

## Testing Plan

### Navigation Nodes
- [ ] Portal nodes display correctly on canvas
- [ ] File-link nodes open target canvas when clicked
- [ ] Placeholder nodes show correct person info
- [ ] Navigation nodes positioned at correct boundaries

### Overview Canvas
- [ ] Overview shows all split canvases
- [ ] Nodes are clickable file links
- [ ] Person counts are accurate
- [ ] Layout is readable for various split counts

### GEDCOM X Import
- [ ] Parse valid GEDCOM X JSON
- [ ] Handle missing/optional fields
- [ ] Map relationships correctly
- [ ] Preserve original IDs

### Gramps Import
- [ ] Parse valid Gramps XML
- [ ] Resolve event references
- [ ] Resolve place references
- [ ] Handle family relationships

---

## References

- [GEDCOM X Specification](https://github.com/FamilySearch/gedcomx/blob/master/specifications/conceptual-model-specification.md)
- [Gramps XML Format](https://gramps-project.org/wiki/index.php/Gramps_XML)
- [Canvas JSON Specification](https://jsoncanvas.org/)
- [Existing canvas-navigation-plan.md](canvas-navigation-plan.md)
